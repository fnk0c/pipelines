include:
  - remote: 'https://raw.githubusercontent.com/rios0rios0/pipelines/main/gitlab/golang/abstracts/go.yaml'

test:all:
  extends: '.go'
  stage: 'tests'
  script:
    # TODO: this should be a share script between the vendors
    - export INIT_SCRIPT="config.sh"
    - "[[ -f $INIT_SCRIPT ]] && ./$INIT_SCRIPT || echo \"The '$INIT_SCRIPT' file is not found, skipping...\""
    - touch coverage.xml
    - go test -v -tags test,unit,integration
        -coverpkg ./main/...
        -covermode=count ./main/...
        -coverprofile=coverage.txt
    - go tool cover -func coverage.txt
    - go install github.com/boumenot/gocover-cobertura@latest
    - gocover-cobertura < coverage.txt > coverage.xml
  coverage: '/total.*?([0-9]{1,3}[.][0-9]{0,2})%/'
  artifacts:
    when: 'always'
    paths:
      - 'coverage.*'
    reports:
      coverage_report:
        coverage_format: 'cobertura'
        path: 'coverage.xml'
